---
interface NavMenuItem {
    title: string;
    href: string;
}

interface Props {
    menuItems?: NavMenuItem[];
}

const {
    menuItems = [
        { title: "Inicio", href: "#home" },
        { title: "Servicios", href: "#services" },
        { title: "Contacto", href: "#contact-form" },
    ],
}: Props = Astro.props;
---

<nav
    class="fixed top-10 inset-x-0 z-50 m-auto flex max-w-fit justify-center rounded-full bg-black/40 py-1 px-1.5 text-white backdrop-blur-md border border-white/10"
>
    <ul class="relative flex items-center gap-1" id="nav-menu">
        <div
            id="nav-backdrop"
            class="absolute left-0 top-0 -z-10 h-full rounded-full bg-white/20 transition-all duration-500 cubic-bezier(0.4, 0, 0.2, 1) opacity-0"
        >
        </div>
        {
            menuItems.map(({ title, href }) => (
                <li class="nav-item">
                    <a
                        class="relative z-10 inline-block px-5 py-2 text-lg font-medium transition-colors hover:text-white/80"
                        href={href}
                    >
                        {title}
                    </a>
                </li>
            ))
        }
    </ul>
</nav>

<script>
    import { effect } from "astro:schema";

    document.addEventListener("astro:page-load", () => {
        const backdrop = document.querySelector("#nav-backdrop") as HTMLElement;
        const items = document.querySelectorAll(".nav-item");
        let activeItem: HTMLElement | null = null;
        let isProgrammaticScroll = false;

        const sectionMap = new Map<HTMLElement, HTMLElement>();

        function moveBackdrop(element: HTMLElement) {
            const { offsetLeft, offsetWidth, offsetHeight } = element;

            backdrop.style.setProperty("left", `${offsetLeft}px`);
            backdrop.style.setProperty("width", `${offsetWidth}px`);
            backdrop.style.setProperty("height", `${offsetHeight}px`);
            backdrop.style.setProperty("opacity", "1");
        }

        items.forEach((item) => {
            const link = item.querySelector("a") as HTMLAnchorElement;
            const id = link.getAttribute("href")?.replace("#", "");
            const section = document.getElementById(id!);

            if (section) {
                sectionMap.set(section, item as HTMLElement);
            }

            item.addEventListener("click", (e) => {
                e.preventDefault();
                isProgrammaticScroll = true; //pausa observer

                activeItem = section;

                moveBackdrop(item as HTMLElement);

                section?.scrollIntoView({ behavior: "smooth", block: "start" });

                setTimeout(() => {
                    isProgrammaticScroll = false;
                }, 800); //ajustable
            });
        });

        //Observer para scroll
        const observer = new IntersectionObserver(
            (entries) => {
                // Si hay un scroll programÃ¡tico activo
                if (activeItem) {
                    const targetEntry = entries.find(
                        (e) => e.target === activeItem && e.isIntersecting,
                    );

                    // Solo reaccionamos cuando el destino REAL entra
                    if (targetEntry) {
                        const navItem = sectionMap.get(activeItem);
                        if (navItem) moveBackdrop(navItem);

                        activeItem = null; // ðŸ‘ˆ liberamos control
                    }

                    return;
                }

                // Scroll normal (manual)
                const visibleEntry = entries
                    .filter((e) => e.isIntersecting)
                    .sort(
                        (a, b) => b.intersectionRatio - a.intersectionRatio,
                    )[0];

                if (!visibleEntry) return;

                const navItem = sectionMap.get(
                    visibleEntry.target as HTMLElement,
                );
                if (navItem) moveBackdrop(navItem);
            },
            {
                threshold: [0.3, 0.6, 0.9],
            },
        );

        // Inicializar en el primer elemento al cargar (opcional)
        window.addEventListener("load", () => {
            const firstItem = items[0] as HTMLElement;
            if (firstItem) moveBackdrop(firstItem);
        });
    });
</script>
